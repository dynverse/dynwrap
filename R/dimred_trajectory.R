#' Perform dimensionality reduction on a trajectory and the respective samples in order to plot it
#'
#' @param trajectory The trajectory
#'
#' @importFrom igraph graph_from_data_frame layout_with_kk
#' @importFrom testthat expect_true
#'
#' @export
dimred_trajectory <- function(
  trajectory,
  adjust_weights = TRUE
) {
  # expect traj to contain a trajectory
  testthat::expect_true(is_data_wrapper(trajectory))
  testthat::expect_true(is_wrapper_with_trajectory(trajectory))

  # retrieve some objects to work with
  name <- trajectory$id
  cell_ids <- trajectory$cell_ids
  milestone_ids <- trajectory$milestone_ids
  num_milestones <- length(milestone_ids)
  milestone_network <-
    trajectory$milestone_network %>%
    filter(to != "FILTERED_CELLS")
  milestone_percentages <- trajectory$milestone_percentages
  is_directed <- any(trajectory$milestone_network$directed)

  structure <- milestone_network

  # add non-visible edges between each pair of end nodes in divergences,
  # for better layout results
  if (!is.null(trajectory$divergence_regions) && nrow(trajectory$divergence_regions) > 0) {
    divergence_edges <-
      get_divergence_triangles(trajectory$divergence_regions) %>%
      left_join(milestone_network %>% select(start = from, node1 = to, length1 = length, directed), by = c("start", "node1")) %>%
      left_join(milestone_network %>% select(start = from, node2 = to, length2 = length), by = c("start", "node2")) %>%
      mutate(length = (length1 + length2) / 2) %>%
      select(from = node1, to = node2, length, directed)
    structure <- bind_rows(structure, divergence_edges)
  }

  # adjust weights on structure to make it easier to plot
  if (adjust_weights && min(structure$length) * 3 < max(structure$length)) {
    structure <- structure %>% mutate(
      length = sqrt(dynutils::scale_minmax(length) + .5)
    )
  }

  # reduce dimensionality on milestone_network
  gr <- igraph::graph_from_data_frame(structure %>% rename(weight = length), vertices = milestone_ids)
  layout <-
    igraph::layout_with_fr(gr, dim = 2, niter = 10000) %>%
    dynutils::scale_uniform() %>%
    set_rownames(milestone_ids) %>%
    set_colnames(paste0("comp_", seq_len(ncol(.))))
  space_milest_df <- layout %>%
    as.data.frame() %>%
    rownames_to_column()

  # project dimensionality to samples
  mix_dimred <- function(milid, milpct) {
    apply(layout[milid,,drop = FALSE], 2, function(x) sum(x * milpct)) %>% t %>% as_data_frame
  }

  # create output for samples
  space_samples <- milestone_percentages %>%
    group_by(cell_id) %>%
    do(mix_dimred(.$milestone_id, .$percentage)) %>%
    ungroup %>%
    slice(match(cell_ids, cell_id)) %>%
    mutate(name)

  # create output for milestones
  space_milestones <- space_milest_df %>%
    rename(milestone_id = rowname) %>%
    mutate(
      name
    )

  # create output for edges between milestones
  space_lines <- milestone_network %>%
    mutate(name) %>%
    left_join(space_milest_df %>% select(from = rowname, from.comp_1 = comp_1, from.comp_2 = comp_2), by = "from") %>%
    left_join(space_milest_df %>% select(to = rowname, to.comp_1 = comp_1, to.comp_2 = comp_2), by = "to")

  # return all output
  l <- lst(
    id = trajectory$id,
    space_milestones = space_milestones,
    space_lines = space_lines,
    space_samples = space_samples
  )
  class(l) <- c("dynwrap::ti_dimred_wrapper", "list")
  l
}

#' Perform dimred trajectory if needed
#' @param object An object generated by \code{wrap_data} or \code{dimred_trajectory}.
#' @rdname dimred_trajectory
#' @export
check_or_perform_dimred <- dynutils::inherit_default_params(
  list(dimred_trajectory),
  function(
    object
  ) {
    if (is_data_wrapper(object) && is_wrapper_with_trajectory(object)) {
      dimred_object <- dimred_trajectory(
        object
      )
    } else if (is_ti_dimred_wrapper(object)) {
      dimred_object <- object
    } else {
      stop(sQuote("object"), " is not an object as generated by wrap_data or dimred_trajectory")
    }
    dimred_object
  }
)

is_ti_dimred_wrapper <- function(object) {
  "dynwrap::ti_dimred_wrapper" %in% class(object)
}

